<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìˆ˜ì˜ì¥ ì´ìš©ê° ì˜ˆì¸¡</title>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; text-align: center; color: #333; }
        h1 { color: #2c3e50; }
        .controls { margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .controls label { font-size: 16px; }
        .controls input[type="date"] { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        button { background-color: #3498db; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .info-box { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; text-align: left; display: none; }
        .info-box h4 { margin-top: 0; }
        #explanation-box { margin-top: 20px; padding: 10px; border-top: 2px solid #3498db; background-color: #ecf0f1; font-size: 14px; color: #34495e; text-align: left; display: none; }
        #chart-container { margin-top: 20px; min-height: 400px; position: relative; }
    </style>
</head>
<body>
    <h1>AI ìˆ˜ì˜ì¥ ì´ìš©ê° ì˜ˆì¸¡</h1>
    
    <div class="controls">
        <label for="predict-date">ì˜ˆì¸¡í•  ë‚ ì§œ ì„ íƒ:</label>
        <input type="date" id="predict-date">
        <button onclick="getPrediction()">ê·¸ë˜í”„ë¡œ ì˜ˆì¸¡ ë³´ê¸°!</button>
    </div>
    
    <h2 id="prediction-title" style="margin-top: 20px;"></h2>
    <div id="weather-info" class="info-box"></div>
    <div id="chart-container">
        <canvas id="predictionChart"></canvas>
    </div>
    <div id="explanation-box" class="info-box"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const datePicker = document.getElementById('predict-date');
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            datePicker.value = tomorrow.toISOString().split('T')[0];
        });

        let myChart = null;

        function getPrediction() {
            const selectedDate = document.getElementById('predict-date').value;
            if (!selectedDate) {
                alert("ì˜ˆì¸¡í•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            document.getElementById('prediction-title').innerText = `${selectedDate} ì˜ˆìƒ í˜¼ì¡ë„`;
            const weatherDiv = document.getElementById('weather-info');
            const chartContainer = document.getElementById('chart-container');
            const explanationBox = document.getElementById('explanation-box');
            
            chartContainer.innerHTML = '<p>AIê°€ ì‹œê°„ëŒ€ë³„ ì˜ˆì¸¡ì„ ê³„ì‚°í•˜ëŠ” ì¤‘...</p>';
            weatherDiv.style.display = 'none';
            explanationBox.style.display = 'none';

            fetch(`/predict?date=${selectedDate}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        chartContainer.innerHTML = `<p style="color: red;">${data.message || data.error}</p>`;
                        return;
                    }
                    
                    const predictions = data.predictions;
                    const weather_source_text = data.weather_source;

                    chartContainer.innerHTML = '<canvas id="predictionChart"></canvas>';
                    const ctx = document.getElementById('predictionChart').getContext('2d');
                    
                    const labels = predictions.map(item => `${item.hour}ì‹œ`);
                    const maleData = predictions.map(item => item.ë‚¨ì_ì˜ˆìƒ);
                    const femaleData = predictions.map(item => item.ì—¬ì_ì˜ˆìƒ);
                    const totalData = maleData.map((d, i) => d + femaleData[i]);

                    if (myChart) { myChart.destroy(); }
                    
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'ë‚¨ì ì˜ˆìƒ ì´ìš©ê°', data: maleData, backgroundColor: 'rgba(54, 162, 235, 0.6)' },
                                { label: 'ì—¬ì ì˜ˆìƒ ì´ìš©ê°', data: femaleData, backgroundColor: 'rgba(255, 99, 132, 0.6)' },
                                {
                                    label: 'ì´ ì˜ˆìƒ ì´ìš©ê°',
                                    data: totalData,
                                    type: 'line',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    fill: false,
                                    tension: 0.1
                                }
                            ]
                        },
                        options: {
                            scales: { y: { beginAtZero: true, title: { display: true, text: 'ì˜ˆìƒ ì´ìš©ê° ìˆ˜ (ëª…)' } } },
                            responsive: true,
                            maintainAspectRatio: false
                        }
                    });

                    // ë‚ ì”¨ ì •ë³´ ë° ì„¤ëª… í‘œì‹œ ë¡œì§
                    if (weather_source_text.includes('ë¯¸í¬í•¨')) {
                        weatherDiv.style.display = 'none';
                        explanationBox.innerHTML = `<p><strong>â€» ì˜ˆì¸¡ ì •ë³´ ì•ˆë‚´</strong></p>
                                                    <ul>
                                                        <li>ì„ íƒí•˜ì‹  ë‚ ì§œëŠ” ë‹¨ê¸°ì˜ˆë³´ ì œê³µ ê¸°ê°„ì„ ë²—ì–´ë‚˜, <strong>ë‚ ì”¨ ì •ë³´ë¥¼ ì œì™¸í•˜ê³ </strong> ê³¼ê±° ì´ìš©ê° ë°ì´í„°ì˜ ì‹œê°„/ìš”ì¼ íŒ¨í„´ë§Œìœ¼ë¡œ AI ëª¨ë¸ì´ ê³„ì‚°í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</li>
                                                        <li>ë‚ ì”¨ ë³€ìˆ˜ê°€ ì œì™¸ë˜ì–´ ì‹¤ì œ ì´ìš©ê° ìˆ˜ì™€ ì˜¤ì°¨ê°€ ë” í´ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
                                                    </ul>`;
                    } else {
                        const avgTemp = predictions.reduce((sum, item) => sum + item.ê¸°ì˜¨, 0) / predictions.length;
                        const totalRain = predictions.reduce((sum, item) => sum + item.ê°•ìˆ˜ëŸ‰, 0);
                        const avgHumidity = predictions.reduce((sum, item) => sum + item.ìŠµë„, 0) / predictions.length;

                        weatherDiv.innerHTML = `<h4>ğŸŒ¦ï¸ ${selectedDate} ì°¸ê³  ë‚ ì”¨ ì˜ˆë³´</h4>
                                              <p><b>ë°ì´í„° ì¶œì²˜: ${weather_source_text}</b></p>
                                              <p>í‰ê· ê¸°ì˜¨: ${avgTemp.toFixed(1)}Â°C | ì´ ê°•ìˆ˜ëŸ‰: ${totalRain.toFixed(1)}mm | í‰ê· ìŠµë„: ${avgHumidity.toFixed(0)}%</p>`;
                        weatherDiv.style.display = 'block';

                        explanationBox.innerHTML = `<p><strong>â€» ì˜ˆì¸¡ ì •ë³´ ì•ˆë‚´</strong></p>
                                                    <ul>
                                                        <li>ë³¸ ì˜ˆì¸¡ì€ ê³¼ê±° 3ë…„ê°„ì˜ ì´ìš©ê° ë°ì´í„°ì™€ ê¸°ìƒì²­ ë‚ ì”¨ ì˜ˆë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ <strong>AI(ë¨¸ì‹ ëŸ¬ë‹) ëª¨ë¸ì´ ê³„ì‚°í•œ ê²°ê³¼</strong>ì…ë‹ˆë‹¤.</li>
                                                        <li>ëª¨ë¸ì˜ í‰ê·  ì˜¤ì°¨ ë²”ìœ„ëŠ” <strong>ë‚¨ì Â±3ëª…, ì—¬ì Â±5ëª…</strong> ìˆ˜ì¤€ì´ë©°, ì‹¤ì œ ì´ìš©ê° ìˆ˜ì™€ ì°¨ì´ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ìš©ìœ¼ë¡œ í™œìš©í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</li>
                                                    </ul>`;
                    }
                    explanationBox.style.display = 'block';
                })
                .catch(err => {
                    console.error('Error:', err);
                    chartContainer.innerHTML = `<p style="color: red;"><strong>ì˜¤ë¥˜ ë°œìƒ:</strong> ${err.message || 'ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>`;
                });
        }
    </script>
</body>
</html>

