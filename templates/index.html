<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>êµ­ë¯¼ì²´ìœ¡ì„¼í„° ìˆ˜ì˜ì¥ í˜¼ì¡ë„ ì•ˆë‚´</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; text-align: center; color: #333; }
        h1, h2 { color: #2c3e50; }
        #current-time { font-size: 16px; color: #555; margin-bottom: 20px; }
        .realtime-container { border: 2px solid #e74c3c; border-radius: 10px; padding: 15px; margin-bottom: 30px; }
        .realtime-container h2 { margin-top: 0; color: #e74c3c; display: flex; align-items: center; justify-content: center; }
        .realtime-container h2::before { content: 'ğŸ”´'; margin-right: 10px; font-size: 16px; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        .status-cards { display: flex; justify-content: space-around; gap: 15px; }
        .card { flex: 1; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h3 { margin-top: 0; color: #555; }
        .card p { font-size: 2.5em; font-weight: bold; color: #2c3e50; margin: 0; }
        .prediction-container { margin-top: 20px; }
        .controls { margin: 20px 0; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        .controls label { font-size: 16px; }
        .controls input[type="date"] { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        button { background-color: #3498db; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        .info-box { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; text-align: left; display: none; }
        #explanation-box { border-top: 2px solid #3498db; }
        #chart-container { margin-top: 20px; min-height: 400px; position: relative; }
    </style>
</head>
<body>
    <h1>êµ­ë¯¼ì²´ìœ¡ì„¼í„° ìˆ˜ì˜ì¥ í˜¼ì¡ë„ ì•ˆë‚´</h1>
    <p id="current-time"></p>

    <div class="realtime-container">
        <h2>ì‹¤ì‹œê°„ ì´ìš© í˜„í™©</h2>
        <div class="status-cards">
            <div class="card total"><h3>ì´ ì¸ì›</h3><p id="total-count">--</p></div>
            <div class="card male"><h3>ğŸ‘¨ ë‚¨ì</h3><p id="male-count">--</p></div>
            <div class="card female"><h3>ğŸ‘©â€ğŸ¦° ì—¬ì</h3><p id="female-count">--</p></div>
        </div>
    </div>

    <div class="prediction-container">
        <h2>AI ì´ìš©ê° ì˜ˆì¸¡</h2>
        <div class="controls">
            <label for="predict-date">íŠ¹ì • ë‚ ì§œ ì˜ˆì¸¡:</label>
            <input type="date" id="predict-date">
            <button onclick="getPredictionByDate()">ì„ íƒ ë‚ ì§œë¡œ ì˜ˆì¸¡ ë³´ê¸°</button>
        </div>
        <p style="font-size: 14px; margin-top: 15px;"><a href="/analysis">AI ì˜ˆì¸¡ ëª¨ë¸ ë¶„ì„ ì •ë³´ ìì„¸íˆ ë³´ê¸°</a></p>
        <h2 id="prediction-title" style="margin-top: 20px;"></h2>
        <div id="weather-info" class="info-box"></div>
        <div id="chart-container"><canvas id="predictionChart"></canvas></div>
        <div id="explanation-box" class="info-box"></div>
    </div>

    <script>
        let myChart = null;

        function drawChart(predictions, weatherSource, selectedDateStr) {
            const weatherDiv = document.getElementById('weather-info');
            const chartContainer = document.getElementById('chart-container');
            const explanationBox = document.getElementById('explanation-box');
            
            chartContainer.innerHTML = '<canvas id="predictionChart"></canvas>';
            const ctx = document.getElementById('predictionChart').getContext('2d');
            
            const labels = predictions.map(item => item.label || `${item.hour}ì‹œ`);
            const maleData = predictions.map(item => item.ë‚¨ì_ì˜ˆìƒ);
            const femaleData = predictions.map(item => item.ì—¬ì_ì˜ˆìƒ);
            const totalData = maleData.map((d, i) => d + femaleData[i]);

            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ë‚¨ì ì˜ˆìƒ ì´ìš©ê°', data: maleData, backgroundColor: 'rgba(54, 162, 235, 0.6)' },
                        { label: 'ì—¬ì ì˜ˆìƒ ì´ìš©ê°', data: femaleData, backgroundColor: 'rgba(255, 99, 132, 0.6)' },
                        { label: 'ì´ ì˜ˆìƒ ì´ìš©ê°', data: totalData, type: 'line', borderColor: 'rgba(75, 192, 192, 1)', fill: false, tension: 0.1 }
                    ]
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'ì˜ˆìƒ ì´ìš©ê° ìˆ˜ (ëª…)' } } }, responsive: true, maintainAspectRatio: false }
            });

            if (weatherSource) {
                if (weatherSource.includes('ë¯¸í¬í•¨')) {
                    weatherDiv.style.display = 'none';
                    explanationBox.innerHTML = `<p><strong>â€» ì˜ˆì¸¡ ì •ë³´ ì•ˆë‚´</strong></p><ul><li>ì„ íƒí•˜ì‹  ë‚ ì§œëŠ” ë‹¨ê¸°ì˜ˆë³´ ì œê³µ ê¸°ê°„ì„ ë²—ì–´ë‚˜, <strong>ë‚ ì”¨ ì •ë³´ë¥¼ ì œì™¸í•˜ê³ </strong> ê³¼ê±° ì´ìš©ê° ë°ì´í„°ì˜ ì‹œê°„/ìš”ì¼/ê³µíœ´ì¼ íŒ¨í„´ë§Œìœ¼ë¡œ AI ëª¨ë¸ì´ ê³„ì‚°í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</li><li>ë‚ ì”¨ ë³€ìˆ˜ê°€ ì œì™¸ë˜ì–´ ì‹¤ì œ ì´ìš©ê° ìˆ˜ì™€ ì˜¤ì°¨ê°€ ë” í´ ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</li></ul>`;
                } else {
                    const avgTemp = predictions.reduce((sum, item) => sum + item.ê¸°ì˜¨, 0) / predictions.length;
                    const totalRain = predictions.reduce((sum, item) => sum + item.ê°•ìˆ˜ëŸ‰, 0);
                    const avgHumidity = predictions.reduce((sum, item) => sum + item.ìŠµë„, 0) / predictions.length;
                    weatherDiv.innerHTML = `<h4>ğŸŒ¦ï¸ ${selectedDateStr} ì°¸ê³  ë‚ ì”¨ ì˜ˆë³´</h4><p><b>ë°ì´í„° ì¶œì²˜: ${weatherSource}</b></p><p>í‰ê· ê¸°ì˜¨: ${avgTemp.toFixed(1)}Â°C | ì´ ê°•ìˆ˜ëŸ‰: ${totalRain.toFixed(1)}mm | í‰ê· ìŠµë„: ${avgHumidity.toFixed(0)}%</p>`;
                    weatherDiv.style.display = 'block';
                    explanationBox.innerHTML = `<p><strong>â€» ì˜ˆì¸¡ ì •ë³´ ì•ˆë‚´</strong></p><ul><li>ë³¸ ì˜ˆì¸¡ì€ ê³¼ê±° 3ë…„ê°„ì˜ ì´ìš©ê° ë°ì´í„°ì™€ ê¸°ìƒì²­ ë‚ ì”¨ ì˜ˆë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ <strong>AI(ë¨¸ì‹ ëŸ¬ë‹) ëª¨ë¸ì´ ê³„ì‚°í•œ ê²°ê³¼</strong>ì…ë‹ˆë‹¤.</li><li>ëª¨ë¸ì˜ í‰ê·  ì˜¤ì°¨ ë²”ìœ„ëŠ” <strong>ë‚¨ì Â±3ëª…, ì—¬ì Â±5ëª…</strong> ìˆ˜ì¤€ì´ë©°, ì‹¤ì œ ì´ìš©ê° ìˆ˜ì™€ ì°¨ì´ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë‹ˆ ì°¸ê³ ìš©ìœ¼ë¡œ í™œìš©í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</li></ul>`;
                }
                explanationBox.style.display = 'block';
            }
        }

        function handleFetchError(err) {
            const chartContainer = document.getElementById('chart-container');
            console.error('Error:', err);
            chartContainer.innerHTML = `<p style="color: red;"><strong>ì˜¤ë¥˜ ë°œìƒ:</strong> ${err.message || 'ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>`;
        }

        // íŠ¹ì • ë‚ ì§œë¥¼ ì„ íƒí•´ì„œ ì˜ˆì¸¡í•˜ëŠ” ê¸°ì¡´ í•¨ìˆ˜
        function getPredictionByDate() {
            const selectedDate = document.getElementById('predict-date').value;
            if (!selectedDate) {
                alert("ì˜ˆì¸¡í•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            document.getElementById('prediction-title').innerText = `${selectedDate} ì˜ˆìƒ í˜¼ì¡ë„`;
            document.getElementById('chart-container').innerHTML = '<p>AIê°€ ì‹œê°„ëŒ€ë³„ ì˜ˆì¸¡ì„ ê³„ì‚°í•˜ëŠ” ì¤‘...</p>';
            
            fetch(`./predict?date=${selectedDate}`)
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(({ status, body }) => {
                    if (status !== 200) { throw body; }
                    drawChart(body.predictions, body.weather_source, selectedDate);
                })
                .catch(handleFetchError);
        }

        // í˜ì´ì§€ ë¡œë”© ì‹œ 48ì‹œê°„ ì˜ˆì¸¡ì„ ì‹¤í–‰í•˜ëŠ” ìƒˆë¡œìš´ í•¨ìˆ˜
        function getLivePrediction() {
            document.getElementById('prediction-title').innerText = `í˜„ì¬ë¶€í„° 48ì‹œê°„ ì˜ˆìƒ í˜¼ì¡ë„`;
            document.getElementById('chart-container').innerHTML = '<p>AIê°€ ì‹¤ì‹œê°„ ì˜ˆì¸¡ì„ ê³„ì‚°í•˜ëŠ” ì¤‘...</p>';
            
            fetch('./predict_live')
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(({ status, body }) => {
                    if (status !== 200) { throw body; }
                    drawChart(body.predictions, null, "ì‹¤ì‹œê°„");
                })
                .catch(handleFetchError);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const datePicker = document.getElementById('predict-date');
            const today = new Date();
            datePicker.min = today.toISOString().split('T')[0];

            const timeDiv = document.getElementById('current-time');
            function updateTime() {
                const now = new Date();
                timeDiv.innerText = now.toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long', hour: '2-digit', minute: '2-digit' });
            }
            updateTime();
            setInterval(updateTime, 1000);

            function simulateRealtimeData() {
                const total = Math.floor(Math.random() * 80) + 10;
                const male = Math.floor(total * (Math.random() * 0.4 + 0.3));
                document.getElementById('total-count').innerText = total;
                document.getElementById('male-count').innerText = male;
                document.getElementById('female-count').innerText = total - male;
            }
            simulateRealtimeData();
            setInterval(simulateRealtimeData, 5000);

            getLivePrediction(); // í˜ì´ì§€ ë¡œë”© ì‹œ 48ì‹œê°„ ì˜ˆì¸¡ ì‹¤í–‰
        });
    </script>
</body>
</html>

